import { useState } from "react";
import axios from "axios";
import { toast, ToastContainer } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";

export default function UploadPage() {
  const [form, setForm] = useState({
    ip: "",
    port: "",
    username: "appuser",
    destPath: "",
    newName: "",
  });
  const [file, setFile] = useState(null);

  const handleChange = (e) => setForm({ ...form, [e.target.name]: e.target.value });

  const handleUpload = async (e) => {
    e.preventDefault();
    const { ip, port, username, destPath, newName } = form;

    if (!file || !ip || !destPath) {
      toast.error("All fields except port and new name are required.");
      return;
    }

    try {
      // Step 1: Upload to Server A
      const formData = new FormData();
      formData.append("file", file);
      const uploadRes = await axios.post("/api/local/upload", formData);
      const tempName = uploadRes.data.tempName;

      // Step 2: Trigger SFTP transfer
      const params = new URLSearchParams({
        ip,
        username,
        destinationPath: destPath,
        fileName: tempName,
        newName,
        port: port || "22",
      });

      await axios.post(`/api/sftp/upload?${params.toString()}`);
      toast.success("✅ File uploaded successfully to remote server!");
    } catch (err) {
      toast.error(`❌ Upload failed: ${err.response?.data?.message || err.message}`);
    }
  };

  return (
    <>
      <div
        className="page"
        style={{
          display: "flex",
          flexDirection: "column",
          justifyContent: "center",
          alignItems: "center",
          height: "calc(80vh - 60px)",
          padding: "20px",
        }}
      >
        <h2>Upload File to Remote Server</h2>
        <form
          onSubmit={handleUpload}
          style={{
            display: "flex",
            flexDirection: "column",
            gap: "10px",
            width: "300px",
          }}
        >
          <input
            type="text"
            name="ip"
            placeholder="IP Address"
            value={form.ip}
            onChange={handleChange}
            required
          />
          <input
            type="text"
            name="port"
            placeholder="Port (optional, default 22)"
            value={form.port}
            onChange={handleChange}
          />
          <input
            type="text"
            name="username"
            placeholder="Username"
            value={form.username}
            onChange={handleChange}
            required
          />
          <input
            type="text"
            name="destPath"
            placeholder="Destination Path"
            value={form.destPath}
            onChange={handleChange}
            required
          />
          <input type="file" onChange={(e) => setFile(e.target.files[0])} required />
          <input
            type="text"
            name="newName"
            placeholder="Rename (optional)"
            value={form.newName}
            onChange={handleChange}
          />
          <button type="submit">Upload</button>
        </form>
        <ToastContainer />
      </div>
    </>
  );
}
