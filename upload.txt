import { useState, useEffect } from "react";
import api from "../utils/api";
import { toast, ToastContainer } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";

export default function UploadPage() {
  const [servers, setServers] = useState([]);
  const [selectedServer, setSelectedServer] = useState("");
  const [formData, setFormData] = useState({
    ip: "",
    username: "",
    port: 22,
    remotePath: "",
    remoteName: "",
  });
  const [file, setFile] = useState(null);

  useEffect(() => {
    loadServers();
  }, []);

  const loadServers = async () => {
    try {
      const res = await api.get("/servers");
      setServers(res.data);
    } catch {
      toast.error("Failed to load servers.");
    }
  };

  const handleServerChange = (e) => {
    const ip = e.target.value;
    setSelectedServer(ip);
    const s = servers.find((srv) => srv.ip === ip);
    if (s) setFormData({ ...formData, ip: s.ip, username: s.username, port: s.port });
  };

  const handleFileChange = (e) => setFile(e.target.files[0]);

  const handleUpload = async (e) => {
    e.preventDefault();
    if (!file) {
      toast.error("Please select a file to upload.");
      return;
    }

    try {
      // STEP 1: Upload to Server A (temporary)
      const uploadData = new FormData();
      uploadData.append("file", file);
      const localRes = await api.post("/local/upload", uploadData, {
        headers: { "Content-Type": "multipart/form-data" },
      });

      const tempName = localRes.data.tempName;

      // STEP 2: Trigger SFTP transfer
      const sftpPayload = {
        ip: formData.ip,
        username: formData.username,
        port: formData.port,
        destinationPath: formData.remotePath,
        fileName: tempName,
        remoteName: formData.remoteName || file.name,
      };
      await api.post("/sftp/upload", sftpPayload);

      toast.success("File transferred successfully!");
      setFile(null);
      setFormData({ ...formData, remotePath: "", remoteName: "" });
    } catch (err) {
      toast.error("Upload failed: " + (err.response?.data?.message || err.message));
    }
  };

  return (
    <>
      <div
        className="page"
        style={{
          display: "flex",
          flexDirection: "column",
          justifyContent: "center",
          alignItems: "center",
          height: "calc(50vh - 60px)",
          padding: "20px",
        }}
      >
        <h2>Upload File</h2>
        <form
          onSubmit={handleUpload}
          style={{
            display: "flex",
            flexDirection: "column",
            gap: "10px",
            width: "300px",
          }}
        >
          <select value={selectedServer} onChange={handleServerChange} required>
            <option value="">Select Server</option>
            {servers.map((s) => (
              <option key={s.id} value={s.ip}>
                {s.ip} ({s.username})
              </option>
            ))}
          </select>

          <input type="text" value={formData.username} readOnly placeholder="Username" />
          <input type="number" value={formData.port} readOnly placeholder="Port" />

          <input
            type="text"
            placeholder="Destination Path (e.g. /home/user/)"
            value={formData.remotePath}
            onChange={(e) => setFormData({ ...formData, remotePath: e.target.value })}
            required
          />

          <input
            type="text"
            placeholder="Rename File (optional)"
            value={formData.remoteName}
            onChange={(e) => setFormData({ ...formData, remoteName: e.target.value })}
          />

          <input type="file" onChange={handleFileChange} required />
          <button type="submit">Upload</button>
        </form>
        <ToastContainer />
      </div>
    </>
  );
}
