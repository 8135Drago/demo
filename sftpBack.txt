package com.example.sftp;

import org.springframework.core.io.FileSystemResource;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.nio.file.*;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

@RestController
@RequestMapping("/api")
public class FileController {

    private final SftpCommandService sftpService;
    private final Map<String, String> tempStorage = new ConcurrentHashMap<>();

    public FileController(SftpCommandService sftpService) {
        this.sftpService = sftpService;
    }

    @PostMapping("/local/upload")
    public ResponseEntity<?> uploadLocal(@RequestParam("file") MultipartFile file) {
        try {
            File temp = File.createTempFile("upload-", file.getOriginalFilename());
            file.transferTo(temp);
            tempStorage.put(file.getOriginalFilename(), temp.getAbsolutePath());
            return ResponseEntity.ok(Map.of(
                    "status", "success",
                    "message", "File uploaded to server A temporarily.",
                    "tempName", file.getOriginalFilename()
            ));
        } catch (Exception e) {
            return ResponseEntity.badRequest().body(Map.of("status", "error", "message", e.getMessage()));
        }
    }

    @PostMapping("/sftp/upload")
    public ResponseEntity<?> sftpUpload(
            @RequestParam String ip,
            @RequestParam String username,
            @RequestParam String destinationPath,
            @RequestParam String fileName,
            @RequestParam(required = false) String newName,
            @RequestParam(required = false, defaultValue = "22") int port) {
        try {
            String localPath = tempStorage.get(fileName);
            if (localPath == null) throw new RuntimeException("No local temp file found.");

            String remoteName = (newName != null && !newName.isBlank()) ? newName : fileName;
            sftpService.uploadFile(username, ip, port, localPath, destinationPath, remoteName);

            Files.deleteIfExists(Paths.get(localPath));
            tempStorage.remove(fileName);

            return ResponseEntity.ok(Map.of("status", "success", "message", "File transferred successfully."));
        } catch (Exception e) {
            return ResponseEntity.badRequest().body(Map.of("status", "error", "message", e.getMessage()));
        }
    }

    @PostMapping("/sftp/download")
    public ResponseEntity<?> sftpDownload(
            @RequestParam String ip,
            @RequestParam String username,
            @RequestParam String sourcePath,
            @RequestParam String fileName,
            @RequestParam(required = false, defaultValue = "22") int port) {
        try {
            File file = sftpService.downloadFile(username, ip, port, sourcePath);
            tempStorage.put(fileName, file.getAbsolutePath());
            return ResponseEntity.ok(Map.of(
                    "status", "success",
                    "message", "File pulled to Server A.",
                    "fileName", fileName
            ));
        } catch (Exception e) {
            return ResponseEntity.badRequest().body(Map.of("status", "error", "message", e.getMessage()));
        }
    }

    @GetMapping("/local/download/{fileName}")
    public ResponseEntity<?> downloadLocal(@PathVariable String fileName) {
        try {
            String path = tempStorage.get(fileName);
            if (path == null) throw new RuntimeException("File not found on Server A.");
            FileSystemResource resource = new FileSystemResource(path);

            ResponseEntity<Resource> response = ResponseEntity.ok()
                    .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=" + fileName)
                    .contentLength(resource.contentLength())
                    .contentType(MediaType.APPLICATION_OCTET_STREAM)
                    .body(resource);

            Files.deleteIfExists(Paths.get(path));
            tempStorage.remove(fileName);
            return response;
        } catch (Exception e) {
            return ResponseEntity.badRequest().body(Map.of("status", "error", "message", e.getMessage()));
        }
    }
}





-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



package com.example.sftp;

import org.springframework.stereotype.Service;
import java.io.*;
import java.nio.file.*;
import java.util.*;

@Service
public class SftpCommandService {

    private String runCommand(List<String> command) throws IOException, InterruptedException {
        ProcessBuilder pb = new ProcessBuilder(command);
        pb.redirectErrorStream(true);
        Process process = pb.start();

        StringBuilder output = new StringBuilder();
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()))) {
            String line;
            while ((line = reader.readLine()) != null) {
                output.append(line).append("\n");
            }
        }

        int exit = process.waitFor();
        if (exit != 0)
            throw new RuntimeException("SFTP error:\n" + output);
        return output.toString();
    }

    public void uploadFile(String username, String ip, int port, String localFile, String remotePath, String remoteName) throws Exception {
        String dest = remotePath.endsWith("/") ? remotePath + remoteName : remotePath + "/" + remoteName;

        File batch = File.createTempFile("upload-", ".txt");
        try (FileWriter fw = new FileWriter(batch)) {
            fw.write("put " + localFile + " " + dest + "\nbye\n");
        }

        List<String> cmd = Arrays.asList("sftp", "-o", "Port=" + port, "-b", batch.getAbsolutePath(), username + "@" + ip);
        runCommand(cmd);
        batch.delete();
    }

    public File downloadFile(String username, String ip, int port, String remotePath) throws Exception {
        File tempFile = Files.createTempFile("download-", "-" + Paths.get(remotePath).getFileName()).toFile();

        File batch = File.createTempFile("download-", ".txt");
        try (FileWriter fw = new FileWriter(batch)) {
            fw.write("get " + remotePath + " " + tempFile.getAbsolutePath() + "\nbye\n");
        }

        List<String> cmd = Arrays.asList("sftp", "-o", "Port=" + port, "-b", batch.getAbsolutePath(), username + "@" + ip);
        runCommand(cmd);
        batch.delete();
        return tempFile;
    }
}







----------------------------------------------------------------------------------------------------------------------



