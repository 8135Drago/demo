import org.apache.poi.openxml4j.opc.OPCPackage;
import org.apache.poi.xssf.eventusermodel.XSSFReader;
import org.apache.poi.xssf.model.SharedStringsTable;
import org.xml.sax.Attributes;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;
import org.xml.sax.XMLReader;
import org.xml.sax.helpers.DefaultHandler;

import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;
import java.io.InputStream;
import java.util.*;

// Configuration class for column extraction
class ColumnConfig {
    private String columnName;
    private int columnIndex;
    
    public ColumnConfig(String columnName, int columnIndex) {
        this.columnName = columnName;
        this.columnIndex = columnIndex;
    }
    
    public String getColumnName() {
        return columnName;
    }
    
    public int getColumnIndex() {
        return columnIndex;
    }
}

// SAX Handler for extracting specific columns
class ColumnExtractionHandler extends DefaultHandler {
    private SharedStringsTable sst;
    private String lastContents;
    private boolean nextIsString;
    private int currentCol = 0;
    private Map<String, List<String>> columnData;
    private Map<Integer, String> columnIndexToName;
    private boolean isFirstRow = true;
    private String currentCellRef;
    
    public ColumnExtractionHandler(SharedStringsTable sst, List<ColumnConfig> configs) {
        this.sst = sst;
        this.columnData = new HashMap<>();
        this.columnIndexToName = new HashMap<>();
        
        // Initialize the map structure
        for (ColumnConfig config : configs) {
            columnData.put(config.getColumnName(), new ArrayList<>());
            columnIndexToName.put(config.getColumnIndex(), config.getColumnName());
        }
    }
    
    @Override
    public void startElement(String uri, String localName, String name, Attributes attributes) {
        if (name.equals("c")) { // Cell
            String cellType = attributes.getValue("t");
            nextIsString = cellType != null && cellType.equals("s");
            
            // Get cell reference (e.g., "A1", "F2")
            currentCellRef = attributes.getValue("r");
            if (currentCellRef != null) {
                currentCol = getColumnIndex(currentCellRef);
            }
        }
        lastContents = "";
    }
    
    @Override
    public void endElement(String uri, String localName, String name) {
        if (nextIsString) {
            try {
                int idx = Integer.parseInt(lastContents);
                lastContents = sst.getItemAt(idx).getString();
            } catch (Exception e) {
                lastContents = "";
            }
        }
        
        if (name.equals("v") || name.equals("t")) { // Value or text
            // Only store if this column is in our config
            if (!isFirstRow && columnIndexToName.containsKey(currentCol)) {
                String columnName = columnIndexToName.get(currentCol);
                columnData.get(columnName).add(lastContents);
            }
        } else if (name.equals("row")) { // End of row
            if (isFirstRow) {
                isFirstRow = false;
            }
            currentCol = 0;
        }
    }
    
    @Override
    public void characters(char[] ch, int start, int length) {
        lastContents += new String(ch, start, length);
    }
    
    // Convert cell reference to column index (A=0, B=1, ..., Z=25, AA=26, etc.)
    private int getColumnIndex(String cellRef) {
        StringBuilder colString = new StringBuilder();
        for (char c : cellRef.toCharArray()) {
            if (Character.isLetter(c)) {
                colString.append(c);
            } else {
                break;
            }
        }
        
        int index = 0;
        for (int i = 0; i < colString.length(); i++) {
            index = index * 26 + (colString.charAt(i) - 'A' + 1);
        }
        return index - 1; // Convert to 0-based index
    }
    
    public Map<String, List<String>> getColumnData() {
        return columnData;
    }
}

public class ExcelColumnExtractor {
    
    /**
     * Extract specific columns from an Excel sheet
     * 
     * @param filePath Path to the Excel file
     * @param sheetName Name of the sheet to read
     * @param columnConfigs List of column configurations (name and index)
     * @return Map where key is column name and value is list of values from that column
     */
    public static Map<String, List<String>> extractColumns(
            String filePath, 
            String sheetName, 
            List<ColumnConfig> columnConfigs) throws Exception {
        
        OPCPackage pkg = OPCPackage.open(filePath);
        XSSFReader reader = new XSSFReader(pkg);
        SharedStringsTable sst = reader.getSharedStringsTable();
        
        // Find the sheet
        String sheetId = findSheet(reader, sheetName);
        if (sheetId == null) {
            pkg.close();
            throw new IllegalArgumentException("Sheet '" + sheetName + "' not found!");
        }
        
        // Parse the sheet
        InputStream sheet = reader.getSheet(sheetId);
        InputSource sheetSource = new InputSource(sheet);
        
        SAXParserFactory saxFactory = SAXParserFactory.newInstance();
        SAXParser saxParser = saxFactory.newSAXParser();
        XMLReader xmlReader = saxParser.getXMLReader();
        
        ColumnExtractionHandler handler = new ColumnExtractionHandler(sst, columnConfigs);
        xmlReader.setContentHandler(handler);
        xmlReader.parse(sheetSource);
        
        sheet.close();
        pkg.close();
        
        return handler.getColumnData();
    }
    
    /**
     * Convenience method for extracting two columns (like key1 and key2)
     */
    public static Map<String, List<String>> extractTwoColumns(
            String filePath,
            String sheetName,
            String column1Name,
            int column1Index,
            String column2Name,
            int column2Index) throws Exception {
        
        List<ColumnConfig> configs = Arrays.asList(
            new ColumnConfig(column1Name, column1Index),
            new ColumnConfig(column2Name, column2Index)
        );
        
        return extractColumns(filePath, sheetName, configs);
    }
    
    private static String findSheet(XSSFReader reader, String sheetName) throws Exception {
        XSSFReader.SheetIterator iter = (XSSFReader.SheetIterator) reader.getSheetsData();
        
        while (iter.hasNext()) {
            InputStream stream = iter.next();
            String name = iter.getSheetName();
            String partName = iter.getSheetPart().getPartName().getName();
            stream.close();
            
            if (name.equals(sheetName)) {
                return partName;
            }
        }
        
        return null;
    }
    
    // Example usage
    public static void main(String[] args) {
        try {
            String filePath = "path/to/your/file.xlsx";
            String sheetName = "ABC";
            
            // Example 1: Extract 2 columns (key1 at column 0, key2 at column 5)
            System.out.println("=== Example 1: Extract 2 columns ===");
            Map<String, List<String>> result = extractTwoColumns(
                filePath, 
                sheetName, 
                "key1", 0,  // Column A (index 0)
                "key2", 5   // Column F (index 5)
            );
            
            System.out.println("key1 count: " + result.get("key1").size());
            System.out.println("key2 count: " + result.get("key2").size());
            System.out.println("\nFirst 5 values of key1:");
            result.get("key1").stream().limit(5).forEach(System.out::println);
            System.out.println("\nFirst 5 values of key2:");
            result.get("key2").stream().limit(5).forEach(System.out::println);
            
            // Example 2: Extract multiple columns (flexible approach)
            System.out.println("\n\n=== Example 2: Extract multiple columns ===");
            List<ColumnConfig> configs = Arrays.asList(
                new ColumnConfig("key1", 0),   // Column A
                new ColumnConfig("key2", 5),   // Column F
                new ColumnConfig("key3", 10),  // Column K
                new ColumnConfig("key4", 15)   // Column P
            );
            
            Map<String, List<String>> multiResult = extractColumns(
                filePath, 
                sheetName, 
                configs
            );
            
            System.out.println("Extracted columns:");
            for (String key : multiResult.keySet()) {
                System.out.println(key + ": " + multiResult.get(key).size() + " values");
            }
            
            // Example 3: Process the data
            System.out.println("\n\n=== Example 3: Processing the data ===");
            processData(result);
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // Example processing function
    private static void processData(Map<String, List<String>> data) {
        List<String> key1Values = data.get("key1");
        List<String> key2Values = data.get("key2");
        
        System.out.println("Processing " + key1Values.size() + " rows...");
        
        // You can now work with the lists as needed
        for (int i = 0; i < Math.min(5, key1Values.size()); i++) {
            System.out.println("Row " + (i+1) + ": key1=" + key1Values.get(i) + 
                             ", key2=" + key2Values.get(i));
        }
    }
}