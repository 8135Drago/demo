// ServerManager.jsx
import React, { useEffect, useMemo, useState } from "react";
import axios from "axios";
import { toast, ToastContainer } from "react-toastify";
import { motion, AnimatePresence } from "framer-motion";
import {
  FaTrash,
  FaPlus,
  FaSearch,
  FaSyncAlt,
  FaSortAmountDownAlt,
  FaSortAmountUpAlt,
  FaEdit,
  FaServer,
  FaTag,
} from "react-icons/fa";
import "react-toastify/dist/ReactToastify.css";

/*
  Requirements satisfied:
   - Search, sort, pagination (client-side)
   - Add, Edit, Delete (with Undo)
   - Tagging (SIT/UAT5, UAT/UAT1, UAT3) - tag UI visible only for roles 'admin' or 'ops'
   - Refresh + loading shimmer
   - Simulated ping with API fallback
   - Activity logging via POST api/actions/log with getAuthHeaders()
*/

// ---------- Helpers for auth & user (adjust as needed) ----------
function getAuthHeaders() {
  // Default: read token from localStorage. Adjust to your auth.
  const token = localStorage.getItem("authToken");
  return token ? { Authorization: `Bearer ${token}` } : {};
}
function getCurrentUser() {
  try {
    const u = JSON.parse(localStorage.getItem("user"));
    // expected shape: { username: 'bob', role: 'admin' }
    if (u && u.username) return u;
  } catch {}
  // fallback default (viewer)
  return { username: "You", role: "viewer" };
}

// ---------- Validation utilities ----------
function isValidIP(ip) {
  // simple IPv4 validation
  if (!ip) return false;
  const parts = ip.trim().split(".");
  if (parts.length !== 4) return false;
  return parts.every((p) => {
    if (p === "") return false;
    const n = Number(p);
    return n >= 0 && n <= 255 && String(n) === p;
  });
}
function isValidPort(p) {
  const n = Number(p);
  return Number.isInteger(n) && n >= 1 && n <= 65535;
}

// ---------- Tag options & role check ----------
const TAG_OPTIONS = ["SIT/UAT5", "UAT/UAT1", "UAT3"];
function canManageTags(role) {
  return role === "admin" || role === "ops";
}

// ---------- Activity log helper ----------
async function logActivity({ username, action, fileName }) {
  try {
    await axios.post(
      "/api/actions/log",
      { username, action, fileName },
      { headers: getAuthHeaders() }
    );
  } catch (err) {
    // non-fatal; ignore/log to console
    // console.warn("Activity log failed", err);
  }
}

// ---------- Main Component ----------
export default function ServerManager() {
  const currentUser = useMemo(() => getCurrentUser(), []);
  // state
  const [servers, setServers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [sortConfig, setSortConfig] = useState({ key: "ip", direction: "asc" });
  const [page, setPage] = useState(1);
  const PAGE_SIZE = 8;
  const [form, setForm] = useState({ ip: "", username: "", port: "22", tag: TAG_OPTIONS[0] });
  const [editingServer, setEditingServer] = useState(null); // {id,...}
  const [deleteQueue, setDeleteQueue] = useState([]); // track items pending undo
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [statusMap, setStatusMap] = useState({}); // id => {status: 'online'|'offline'|'unknown', lastChecked }

  // load servers
  const loadServers = async () => {
    setLoading(true);
    try {
      const res = await axios.get("/api/servers", { headers: getAuthHeaders() });
      const data = Array.isArray(res.data) ? res.data : [];
      setServers(data);
      // ping statuses
      checkManyStatuses(data);
    } catch (err) {
      toast.error("Failed to load servers");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadServers();
  }, []);

  // refresh handler
  const handleRefresh = async () => {
    setIsRefreshing(true);
    await loadServers();
    setTimeout(() => setIsRefreshing(false), 600); // small UX delay
  };

  // add server
  const handleAdd = async (e) => {
    e?.preventDefault?.();
    if (!isValidIP(form.ip)) {
      toast.error("Invalid IP address");
      return;
    }
    if (!isValidPort(form.port)) {
      toast.error("Invalid port (1-65535)");
      return;
    }
    const payload = {
      ip: form.ip.trim(),
      username: form.username.trim(),
      port: form.port,
      environment: form.tag || null,
      status: "unknown",
    };
    try {
      await axios.post("/api/servers", payload, { headers: getAuthHeaders() });
      toast.success("Server added");
      logActivity({
        username: currentUser.username,
        action: `Added server ${payload.ip}`,
      });
      setForm({ ip: "", username: "", port: "22", tag: TAG_OPTIONS[0] });
      loadServers();
    } catch (err) {
      toast.error("Failed to add server: " + (err?.message || ""));
    }
  };

  // edit server (open modal)
  const openEdit = (s) => {
    setEditingServer({ ...s }); // copy
  };

  const handleEditSave = async (updated) => {
    if (!isValidIP(updated.ip)) {
      toast.error("Invalid IP address");
      return;
    }
    if (!isValidPort(updated.port)) {
      toast.error("Invalid port (1-65535)");
      return;
    }
    try {
      // PUT endpoint (we'll provide backend example below)
      await axios.put(`/api/servers/${updated.id}`, updated, { headers: getAuthHeaders() });
      toast.success("Server updated");
      logActivity({
        username: currentUser.username,
        action: `Updated server ${updated.ip}`,
      });
      setEditingServer(null);
      loadServers();
    } catch (err) {
      toast.error("Failed to update server: " + (err?.message || ""));
    }
  };

  // delete with undo
  const handleDelete = async (s) => {
    // remove locally first (optimistic)
    setServers((prev) => prev.filter((x) => x.id !== s.id));
    // add to deleteQueue for undo
    const undoToken = { server: s, createdAt: Date.now() };
    setDeleteQueue((q) => [...q, undoToken]);

    // show toast with Undo action
    toast(
      ({ closeToast }) => (
        <div className="flex items-center gap-4">
          <div>
            <strong>Deleted {s.ip}</strong>
            <div className="text-xs text-gray-300">You can undo this action</div>
          </div>
          <div className="ml-auto flex gap-2">
            <button
              onClick={async () => {
                // undo: re-create on server
                try {
                  await axios.post("/api/servers", {
                    ip: s.ip,
                    username: s.username,
                    port: s.port,
                    environment: s.environment,
                    status: s.status || "unknown",
                  }, { headers: getAuthHeaders() });
                  toast.success("Restore successful");
                  logActivity({
                    username: currentUser.username,
                    action: `Restored server ${s.ip}`,
                  });
                  // remove from deleteQueue and reload
                  setDeleteQueue((q) => q.filter((d) => d !== undoToken));
                  loadServers();
                  closeToast();
                } catch (err) {
                  toast.error("Restore failed");
                  closeToast();
                }
              }}
              className="bg-red-600 px-3 py-1 rounded text-white"
            >
              Undo
            </button>
          </div>
        </div>
      ),
      { autoClose: 6000 }
    );

    // log activity
    logActivity({
      username: currentUser.username,
      action: `Deleted server ${s.ip}`,
    });

    // call delete endpoint
    try {
      await axios.delete(`/api/servers/${s.id}`, { headers: getAuthHeaders() });
      // success - remove from queue permanently
      setDeleteQueue((q) => q.filter((d) => d !== undoToken));
    } catch (err) {
      // If delete fails (e.g., server not found) - show error and reload
      toast.error("Delete failed, refreshing list");
      loadServers();
    }
  };

  // --------- Search & Sort & Pagination ----------
  const filtered = useMemo(() => {
    const q = search.trim().toLowerCase();
    let data = [...servers];
    if (q) {
      data = data.filter(
        (s) =>
          (s.ip || "").toLowerCase().includes(q) ||
          (s.username || "").toLowerCase().includes(q) ||
          (String(s.port) || "").includes(q) ||
          ((s.environment || "") + "").toLowerCase().includes(q)
      );
    }

    if (sortConfig.key) {
      data.sort((a, b) => {
        const av = (a[sortConfig.key] ?? "").toString().toLowerCase();
        const bv = (b[sortConfig.key] ?? "").toString().toLowerCase();
        if (av < bv) return sortConfig.direction === "asc" ? -1 : 1;
        if (av > bv) return sortConfig.direction === "asc" ? 1 : -1;
        return 0;
      });
    }
    return data;
  }, [servers, search, sortConfig]);

  useEffect(() => setPage(1), [search, sortConfig]);

  const pageCount = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
  const pageData = filtered.slice((page - 1) * PAGE_SIZE, page * PAGE_SIZE);

  const toggleSort = (key) =>
    setSortConfig((prev) => ({
      key,
      direction: prev.key === key && prev.direction === "asc" ? "desc" : "asc",
    }));

  // ---------- Status check (ping) ----------
  // Try API ping first; if no endpoint or error, fallback to simulated ping (random).
  async function checkStatusForServer(s) {
    try {
      const res = await axios.post(`/api/servers/${s.id}/ping`, {}, { headers: getAuthHeaders(), timeout: 3000 });
      const ok = res?.data?.ok;
      setStatusMap((m) => ({ ...m, [s.id]: { status: ok ? "online" : "offline", lastChecked: Date.now() } }));
    } catch (err) {
      // fallback simulated ping
      const online = Math.random() > 0.35; // ~65% online
      setStatusMap((m) => ({ ...m, [s.id]: { status: online ? "online" : "offline", lastChecked: Date.now() } }));
    }
  }

  function checkManyStatuses(list) {
    if (!Array.isArray(list)) return;
    list.forEach((s, idx) => {
      // staggered ping to avoid burst
      setTimeout(() => checkStatusForServer(s), 100 * idx);
    });
  }

  // manual check single server
  const handleCheckNow = (s) => {
    setStatusMap((m) => ({ ...m, [s.id]: { status: "checking", lastChecked: Date.now() } }));
    checkStatusForServer(s);
  };

  // ----------- UI subcomponents -------------
  function Toolbar() {
    return (
      <div className="w-full max-w-4xl sticky top-4 z-40 bg-transparent">
        <div className="flex gap-3 items-center justify-between">
          <div className="flex gap-3 items-center">
            <div className="bg-zinc-900 border border-zinc-700 px-3 py-2 rounded-lg flex items-center gap-2 w-64">
              <FaSearch className="text-zinc-400" />
              <input
                placeholder="Search IP / username / env..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="bg-transparent outline-none text-white w-full"
              />
            </div>

            <button
              onClick={handleRefresh}
              className={`flex items-center gap-2 px-3 py-2 rounded-lg border ${isRefreshing ? "border-red-500" : "border-zinc-700"} hover:bg-zinc-800 transition`}
            >
              <FaSyncAlt className={isRefreshing ? "animate-spin" : ""} />
              Refresh
            </button>
          </div>

          <div className="flex gap-3 items-center">
            <div className="text-sm text-zinc-400">Logged as: <span className="text-white">{currentUser.username}</span> ({currentUser.role})</div>
          </div>
        </div>
      </div>
    );
  }

  function AddForm() {
    return (
      <motion.form
        onSubmit={handleAdd}
        initial={{ opacity: 0, y: -8 }}
        animate={{ opacity: 1, y: 0 }}
        className="bg-zinc-800 shadow-lg rounded-2xl p-5 w-full max-w-4xl mt-6 border border-zinc-700"
      >
        <div className="flex flex-col sm:flex-row gap-3">
          <input
            value={form.ip}
            onChange={(e) => setForm((f) => ({ ...f, ip: e.target.value }))}
            placeholder="IP address"
            className="p-3 rounded bg-zinc-900 border border-zinc-700 flex-1 outline-none"
          />
          <input
            value={form.username}
            onChange={(e) => setForm((f) => ({ ...f, username: e.target.value }))}
            placeholder="Username"
            className="p-3 rounded bg-zinc-900 border border-zinc-700 w-56 outline-none"
          />
          <input
            value={form.port}
            onChange={(e) => setForm((f) => ({ ...f, port: e.target.value }))}
            placeholder="Port"
            className="p-3 rounded bg-zinc-900 border border-zinc-700 w-28 outline-none"
          />
          {canManageTags(currentUser.role) && (
            <select
              value={form.tag}
              onChange={(e) => setForm((f) => ({ ...f, tag: e.target.value }))}
              className="p-3 rounded bg-zinc-900 border border-zinc-700 w-44 outline-none"
              title="Environment tag (admin/ops only)"
            >
              {TAG_OPTIONS.map((t) => (
                <option value={t} key={t}>{t}</option>
              ))}
            </select>
          )}
          <button type="submit" className="bg-red-600 px-4 py-2 rounded-lg text-white flex items-center gap-2">
            <FaPlus /> Add
          </button>
        </div>
      </motion.form>
    );
  }

  function Table() {
    return (
      <div className="mt-4 w-full max-w-4xl bg-zinc-900 rounded-xl overflow-hidden border border-zinc-700 shadow-lg">
        <div className="overflow-y-auto max-h-[480px]">
          <table className="w-full text-left border-collapse">
            <thead className="bg-red-700/80 sticky top-0">
              <tr>
                <th className="p-3">IP
                  <SortButton keyName="ip" />
                </th>
                <th className="p-3">Username
                  <SortButton keyName="username" />
                </th>
                <th className="p-3">Port
                  <SortButton keyName="port" />
                </th>
                <th className="p-3">Env</th>
                <th className="p-3 text-center">Status</th>
                <th className="p-3 text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {loading ? (
                [...Array(PAGE_SIZE)].map((_, i) => (
                  <tr key={i} className="animate-pulse">
                    <td className="p-3"><div className="h-4 bg-zinc-800 rounded w-32"></div></td>
                    <td className="p-3"><div className="h-4 bg-zinc-800 rounded w-20"></div></td>
                    <td className="p-3"><div className="h-4 bg-zinc-800 rounded w-12"></div></td>
                    <td className="p-3"><div className="h-4 bg-zinc-800 rounded w-20"></div></td>
                    <td className="p-3 text-center"><div className="h-4 bg-zinc-800 rounded w-20 mx-auto"></div></td>
                    <td className="p-3 text-center"><div className="h-4 bg-zinc-800 rounded w-20 mx-auto"></div></td>
                  </tr>
                ))
              ) : pageData.length > 0 ? (
                pageData.map((s) => (
                  <motion.tr
                    key={s.id}
                    className="border-b border-zinc-800 hover:bg-zinc-800/80 transition-all"
                    initial={{ opacity: 0, y: 6 }}
                    animate={{ opacity: 1, y: 0 }}
                  >
                    <td className="p-3 font-mono">{s.ip}</td>
                    <td className="p-3">{s.username}</td>
                    <td className="p-3">{s.port}</td>
                    <td className="p-3 flex items-center gap-2">
                      <FaTag className="text-zinc-400" />
                      <span>{s.environment || "-"}</span>
                    </td>
                    <td className="p-3 text-center">
                      <StatusBadge server={s} />
                    </td>
                    <td className="p-3 text-center">
                      <div className="flex items-center justify-center gap-3">
                        <button onClick={() => openEdit(s)} title="Edit" className="p-2 rounded hover:bg-zinc-800">
                          <FaEdit className="text-zinc-300" />
                        </button>
                        <button onClick={() => handleCheckNow(s)} title="Check Status" className="p-2 rounded hover:bg-zinc-800">
                          üîÅ
                        </button>
                        <button onClick={() => handleDelete(s)} title="Delete" className="p-2 rounded hover:bg-zinc-800">
                          <FaTrash className="text-red-400" />
                        </button>
                      </div>
                    </td>
                  </motion.tr>
                ))
              ) : (
                <tr>
                  <td colSpan="6" className="p-8 text-center text-zinc-400">
                    No servers found.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
        <Pagination />
      </div>
    );
  }

  function SortButton({ keyName }) {
    const isActive = sortConfig.key === keyName;
    return (
      <button
        onClick={() => toggleSort(keyName)}
        title={`Sort by ${keyName}`}
        className={`ml-2 inline-flex items-center text-xs ${isActive ? "text-red-300" : "text-zinc-200"}`}
      >
        {isActive && sortConfig.direction === "asc" ? <FaSortAmountUpAlt /> : <FaSortAmountDownAlt />}
      </button>
    );
  }

  function StatusBadge({ server }) {
    const st = statusMap[server.id]?.status ?? server.status ?? "unknown";
    const last = statusMap[server.id]?.lastChecked;
    const color =
      st === "online" ? "bg-green-600 text-white" : st === "offline" ? "bg-red-600 text-white" : "bg-zinc-700 text-white";
    return (
      <div className="flex flex-col items-center">
        <div className={`px-3 py-1 rounded-full text-sm ${color} inline-flex items-center gap-2`}>
          <span className="w-2 h-2 rounded-full" style={{ backgroundColor: st === "online" ? "#16a34a" : st === "offline" ? "#dc2626" : "#6b7280" }} />
          <span>{st}</span>
        </div>
        <div className="text-xs text-zinc-500">{last ? new Date(last).toLocaleTimeString() : "-"}</div>
      </div>
    );
  }

  function Pagination() {
    return (
      <div className="flex items-center justify-between px-4 py-3 bg-zinc-900/80 border-t border-zinc-800">
        <div className="text-zinc-400 text-sm">
          Showing <strong>{(page - 1) * PAGE_SIZE + 1}</strong> - <strong>{Math.min(page * PAGE_SIZE, filtered.length)}</strong> of <strong>{filtered.length}</strong>
        </div>
        <div className="flex gap-2">
          <button onClick={() => setPage(1)} disabled={page === 1} className="px-3 py-1 rounded border border-zinc-700">First</button>
          <button onClick={() => setPage((p) => Math.max(1, p - 1))} disabled={page === 1} className="px-3 py-1 rounded border border-zinc-700">Prev</button>
          <div className="px-3 py-1 rounded border border-zinc-700">{page}</div>
          <button onClick={() => setPage((p) => Math.min(pageCount, p + 1))} disabled={page === pageCount} className="px-3 py-1 rounded border border-zinc-700">Next</button>
          <button onClick={() => setPage(pageCount)} disabled={page === pageCount} className="px-3 py-1 rounded border border-zinc-700">Last</button>
        </div>
      </div>
    );
  }

  // Edit modal
  function EditModal() {
    const [local, setLocal] = useState(editingServer);
    useEffect(() => setLocal(editingServer), [editingServer]);
    if (!editingServer) return null;
    return (
      <AnimatePresence>
        <motion.div
          key="edit-modal"
          className="fixed inset-0 flex items-center justify-center bg-black/70 z-50"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
        >
          <motion.div className="bg-zinc-900 p-6 rounded-2xl border border-red-600 w-96" initial={{ scale: 0.9 }} animate={{ scale: 1 }} exit={{ scale: 0.9 }}>
            <h3 className="text-lg font-semibold text-red-300 mb-4">Edit Server</h3>
            <div className="flex flex-col gap-3">
              <input value={local.ip} onChange={(e) => setLocal((l) => ({ ...l, ip: e.target.value }))} className="p-2 rounded bg-zinc-800 border border-zinc-700" />
              <input value={local.username} onChange={(e) => setLocal((l) => ({ ...l, username: e.target.value }))} className="p-2 rounded bg-zinc-800 border border-zinc-700" />
              <input value={local.port} onChange={(e) => setLocal((l) => ({ ...l, port: e.target.value }))} className="p-2 rounded bg-zinc-800 border border-zinc-700" />
              {canManageTags(currentUser.role) && (
                <select value={local.environment || TAG_OPTIONS[0]} onChange={(e) => setLocal((l) => ({ ...l, environment: e.target.value }))} className="p-2 rounded bg-zinc-800 border border-zinc-700">
                  {TAG_OPTIONS.map((t) => <option key={t} value={t}>{t}</option>)}
                </select>
              )}
              <div className="flex justify-end gap-3 mt-2">
                <button onClick={() => setEditingServer(null)} className="px-3 py-2 rounded border border-zinc-700">Cancel</button>
                <button onClick={() => handleEditSave(local)} className="px-3 py-2 rounded bg-red-600 text-white">Save</button>
              </div>
            </div>
          </motion.div>
        </motion.div>
      </AnimatePresence>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-black via-zinc-900 to-red-950 text-white p-6 flex flex-col items-center">
      <motion.header className="w-full max-w-4xl flex items-center justify-between mb-3">
        <motion.h1 className="text-3xl font-bold text-red-400 flex items-center gap-3">
          <FaServer /> Server Manager
        </motion.h1>
        <div className="text-sm text-zinc-400">Dark theme ‚Äî red / black / white</div>
      </motion.header>

      <Toolbar />
      <AddForm />
      <Table />
      <EditModal />

      <ToastContainer position="bottom-right" />

    </div>
  );
}
