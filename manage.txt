import org.apache.poi.openxml4j.opc.OPCPackage;
import org.apache.poi.ss.usermodel.DataFormatter;
import org.apache.poi.xssf.eventusermodel.XSSFReader;
import org.apache.poi.xssf.model.SharedStringsTable;
import org.apache.poi.xssf.usermodel.XSSFRichTextString;
import org.xml.sax.Attributes;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;
import org.xml.sax.XMLReader;
import org.xml.sax.helpers.DefaultHandler;

import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

// POJO for ABC Sheet
class ABCData {
    private String column1;
    private String column2;
    private String column3;
    // Add more fields as needed
    
    public ABCData(List<String> rowData) {
        this.column1 = rowData.size() > 0 ? rowData.get(0) : "";
        this.column2 = rowData.size() > 1 ? rowData.get(1) : "";
        this.column3 = rowData.size() > 2 ? rowData.get(2) : "";
    }
    
    @Override
    public String toString() {
        return "ABCData{" +
                "column1='" + column1 + '\'' +
                ", column2='" + column2 + '\'' +
                ", column3='" + column3 + '\'' +
                '}';
    }
}

// POJO for XYZ Sheet
class XYZData {
    private String fieldA;
    private String fieldB;
    private String fieldC;
    // Add more fields as needed
    
    public XYZData(List<String> rowData) {
        this.fieldA = rowData.size() > 0 ? rowData.get(0) : "";
        this.fieldB = rowData.size() > 1 ? rowData.get(1) : "";
        this.fieldC = rowData.size() > 2 ? rowData.get(2) : "";
    }
    
    @Override
    public String toString() {
        return "XYZData{" +
                "fieldA='" + fieldA + '\'' +
                ", fieldB='" + fieldB + '\'' +
                ", fieldC='" + fieldC + '\'' +
                '}';
    }
}

// SAX Handler for parsing sheet data
class SheetHandler extends DefaultHandler {
    private SharedStringsTable sst;
    private String lastContents;
    private boolean nextIsString;
    private List<String> currentRow = new ArrayList<>();
    private List<List<String>> allRows = new ArrayList<>();
    private boolean isFirstRow = true;
    private DataFormatter formatter = new DataFormatter();
    
    public SheetHandler(SharedStringsTable sst) {
        this.sst = sst;
    }
    
    @Override
    public void startElement(String uri, String localName, String name, Attributes attributes) {
        if (name.equals("c")) { // Cell
            String cellType = attributes.getValue("t");
            nextIsString = cellType != null && cellType.equals("s");
        }
        lastContents = "";
    }
    
    @Override
    public void endElement(String uri, String localName, String name) {
        if (nextIsString) {
            try {
                int idx = Integer.parseInt(lastContents);
                lastContents = new XSSFRichTextString(sst.getEntryAt(idx)).toString();
            } catch (Exception e) {
                // Handle exception
            }
        }
        
        if (name.equals("v") || name.equals("t")) { // Value or text
            currentRow.add(lastContents);
        } else if (name.equals("row")) { // End of row
            if (!isFirstRow) { // Skip header row if needed
                allRows.add(new ArrayList<>(currentRow));
            } else {
                isFirstRow = false;
            }
            currentRow.clear();
        }
    }
    
    @Override
    public void characters(char[] ch, int start, int length) {
        lastContents += new String(ch, start, length);
    }
    
    public List<List<String>> getRows() {
        return allRows;
    }
}

public class ExcelStreamingReader {
    private static final int CHUNK_SIZE = 1000; // Adjust as needed
    
    public static void main(String[] args) {
        String filePath = "path/to/your/large-file.xlsx";
        
        try {
            processExcelFile(filePath);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public static void processExcelFile(String filePath) throws Exception {
        OPCPackage pkg = OPCPackage.open(filePath);
        XSSFReader reader = new XSSFReader(pkg);
        SharedStringsTable sst = reader.getSharedStringsTable();
        
        // Get sheet names and their IDs
        Map<String, String> sheetMap = getSheetMap(reader);
        
        int abcCount = 0;
        int xyzCount = 0;
        
        // Process ABC sheet
        if (sheetMap.containsKey("ABC")) {
            System.out.println("Processing ABC sheet...");
            abcCount = processSheet(reader, sst, sheetMap.get("ABC"), "ABC");
        } else {
            System.out.println("ABC sheet not found!");
        }
        
        // Process XYZ sheet
        if (sheetMap.containsKey("XYZ")) {
            System.out.println("\nProcessing XYZ sheet...");
            xyzCount = processSheet(reader, sst, sheetMap.get("XYZ"), "XYZ");
        } else {
            System.out.println("XYZ sheet not found!");
        }
        
        pkg.close();
        
        // Print final counts
        System.out.println("\n=== Processing Complete ===");
        System.out.println("ABC Sheet Total Rows: " + abcCount);
        System.out.println("XYZ Sheet Total Rows: " + xyzCount);
        System.out.println("Total Rows Processed: " + (abcCount + xyzCount));
    }
    
    private static Map<String, String> getSheetMap(XSSFReader reader) throws Exception {
        Map<String, String> sheetMap = new HashMap<>();
        XSSFReader.SheetIterator iter = (XSSFReader.SheetIterator) reader.getSheetsData();
        
        while (iter.hasNext()) {
            InputStream stream = iter.next();
            String sheetName = iter.getSheetName();
            sheetMap.put(sheetName, iter.getSheetPart().getPartName().getName());
            stream.close();
        }
        
        return sheetMap;
    }
    
    private static int processSheet(XSSFReader reader, SharedStringsTable sst, 
                                     String sheetId, String sheetName) throws Exception {
        InputStream sheet = reader.getSheet(sheetId);
        InputSource sheetSource = new InputSource(sheet);
        
        SAXParserFactory saxFactory = SAXParserFactory.newInstance();
        SAXParser saxParser = saxFactory.newSAXParser();
        XMLReader xmlReader = saxParser.getXMLReader();
        
        SheetHandler handler = new SheetHandler(sst);
        xmlReader.setContentHandler(handler);
        xmlReader.parse(sheetSource);
        
        List<List<String>> rows = handler.getRows();
        sheet.close();
        
        // Process rows in chunks
        int totalRows = rows.size();
        int processedRows = 0;
        
        for (int i = 0; i < rows.size(); i += CHUNK_SIZE) {
            int end = Math.min(i + CHUNK_SIZE, rows.size());
            List<List<String>> chunk = rows.subList(i, end);
            
            if (sheetName.equals("ABC")) {
                List<ABCData> abcList = new ArrayList<>();
                for (List<String> row : chunk) {
                    abcList.add(new ABCData(row));
                }
                processABCData(abcList);
                processedRows += abcList.size();
            } else if (sheetName.equals("XYZ")) {
                List<XYZData> xyzList = new ArrayList<>();
                for (List<String> row : chunk) {
                    xyzList.add(new XYZData(row));
                }
                processXYZData(xyzList);
                processedRows += xyzList.size();
            }
            
            System.out.println("Processed " + processedRows + "/" + totalRows + " rows from " + sheetName);
        }
        
        return totalRows;
    }
    
    // Function to process ABC data chunks
    private static void processABCData(List<ABCData> dataList) {
        System.out.println("\n--- Processing ABC Chunk (" + dataList.size() + " records) ---");
        for (ABCData data : dataList) {
            System.out.println(data);
        }
    }
    
    // Function to process XYZ data chunks
    private static void processXYZData(List<XYZData> dataList) {
        System.out.println("\n--- Processing XYZ Chunk (" + dataList.size() + " records) ---");
        for (XYZData data : dataList.size() > 5 ? dataList.subList(0, 5) : dataList) {
            System.out.println(data);
        }
        if (dataList.size() > 5) {
            System.out.println("... (" + (dataList.size() - 5) + " more records)");
        }
    }
}