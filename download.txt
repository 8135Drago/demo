import { useState, useEffect } from "react";
import api from "../utils/api";
import { toast, ToastContainer } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";

export default function DownloadPage() {
  const [servers, setServers] = useState([]);
  const [selectedServer, setSelectedServer] = useState("");
  const [formData, setFormData] = useState({
    ip: "",
    username: "",
    port: 22,
    remotePath: "",
    fileName: "",
  });

  useEffect(() => {
    loadServers();
  }, []);

  const loadServers = async () => {
    try {
      const res = await api.get("/servers");
      setServers(res.data);
    } catch {
      toast.error("Failed to load servers.");
    }
  };

  const handleServerChange = (e) => {
    const ip = e.target.value;
    setSelectedServer(ip);
    const s = servers.find((srv) => srv.ip === ip);
    if (s) setFormData({ ...formData, ip: s.ip, username: s.username, port: s.port });
  };

  const handleDownload = async (e) => {
    e.preventDefault();
    if (!formData.remotePath || !formData.fileName) {
      toast.error("Enter both remote path and file name.");
      return;
    }

    try {
      // STEP 1: Trigger SFTP pull
      const sftpRes = await api.post("/sftp/download", formData);
      const tempName = sftpRes.data.tempName;

      // STEP 2: Download from Server A
      const res = await api.get(`/local/download/${tempName}`, { responseType: "blob" });
      const blob = new Blob([res.data]);
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = formData.fileName;
      a.click();
      a.remove();

      toast.success("File downloaded successfully!");
    } catch (err) {
      toast.error("Download failed: " + (err.response?.data?.message || err.message));
    }
  };

  return (
    <>
      <div
        className="page"
        style={{
          display: "flex",
          flexDirection: "column",
          justifyContent: "center",
          alignItems: "center",
          height: "calc(50vh - 60px)",
          padding: "20px",
        }}
      >
        <h2>Download File</h2>
        <form
          onSubmit={handleDownload}
          style={{
            display: "flex",
            flexDirection: "column",
            gap: "10px",
            width: "300px",
          }}
        >
          <select value={selectedServer} onChange={handleServerChange} required>
            <option value="">Select Server</option>
            {servers.map((s) => (
              <option key={s.id} value={s.ip}>
                {s.ip} ({s.username})
              </option>
            ))}
          </select>

          <input type="text" value={formData.username} readOnly placeholder="Username" />
          <input type="number" value={formData.port} readOnly placeholder="Port" />

          <input
            type="text"
            placeholder="Remote Path (e.g. /home/user/)"
            value={formData.remotePath}
            onChange={(e) => setFormData({ ...formData, remotePath: e.target.value })}
            required
          />

          <input
            type="text"
            placeholder="File Name"
            value={formData.fileName}
            onChange={(e) => setFormData({ ...formData, fileName: e.target.value })}
            required
          />

          <button type="submit">Download</button>
        </form>
        <ToastContainer />
      </div>
    </>
  );
}
